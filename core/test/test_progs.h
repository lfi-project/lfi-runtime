#pragma once

#if defined(LFI_ARCH_ARM64)

static uint8_t prog[] = {
    0x00, 0x00, 0x01, 0x8b, // add x0, x0, x1
    0xc0, 0x03, 0x5f, 0xd6, // ret
};

static uint8_t prog_cb[] = {
    0xe2, 0x03, 0x00, 0xaa, // mov x2, x0
    0xe0, 0x03, 0x01, 0x2a, // mov w0, w1
    0xb2, 0x42, 0x22, 0x8b, // add x18, x21, w2, uxtw
    0x40, 0x02, 0x1f, 0xd6, // br x18
};

static uint8_t ret[] = {
    0xf6, 0x03, 0x1e, 0xaa, // mov x22, x30
    0xbe, 0x0e, 0x40, 0xf9, // ldr x30, [x21, #24]
    0xc0, 0x03, 0x3f, 0xd6, // blr x30
    0xbe, 0x42, 0x36, 0x8b, // add x30, x21, w22, uxtw
};

#elif defined(LFI_ARCH_X64)

static uint8_t prog[] = {
    0x48, 0x01, 0xfe,       // add %rdi, %rsi
    0x48, 0x89, 0xf0,       // mov %rsi, %rax
    0x41, 0x5b,             // pop %r11
    0x41, 0x83, 0xe3, 0xe0, // and $0xffffffe0, %r11d
    0x4d, 0x09, 0xf3,       // or %r14, %r11
    0x41, 0xff, 0xe3,       // jmp *%r11
    0x66, 0x2e, 0x0f, 0x1f, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, // nop
    0x0f, 0x1f, 0x40, 0x00,                                     // nop
};

_Static_assert(sizeof(prog) % 32 == 0, "end of prog is not bundle-aligned");

static uint8_t prog_cb[] = {
    // clang-format off
    0x48, 0x89, 0xf8, // mov %rdi, %rax
    0x89, 0xf7,       // mov %esi, %edi
    0x83, 0xe0, 0xe0, // and $0xffffffe0, %eax
    0x4c, 0x09, 0xf0, // or %r14, %rax
    0xff, 0xe0,       // jmp *%rax
    0x66, 0x2e, 0x0f, 0x1f, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, // nop
    0x0f, 0x1f, 0x40, 0x00, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,       // nop/int3
    // clang-format on
};

_Static_assert(sizeof(prog_cb) % 32 == 0,
    "end of prog_cb is not bundle-aligned");

static uint8_t ret[] = {
    0x4c, 0x8d, 0x1d, 0x04, 0x00, 0x00, 0x00, // lea 0x4(%rip), %r11
    0x41, 0xff, 0x66, 0x18,                   // jmp *0x18(%r14)
};

#else

#error "architecture not supported"

#endif

